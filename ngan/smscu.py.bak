from zlapi.models import *
import datetime
import os
import subprocess

last_sms_times = {}
admin_ids = ['418669971689260834', '829533890641590956']  # Thay tháº¿ báº±ng ID admin thá»±c táº¿

des = {
    'version': "1.0.1",
    'credits': "ğ•„ğ•£â„š",
    'description': "ğŸš€ ğ•Šğ•¡ğ•’ğ• ğ•Šğ•„ğ•Š ğ•§ğ•’Ì€ ğ•˜ğ• Ì£ğ•š ğ••ğ•šğ•–Ì£Ì‚ğ•Ÿ ğ•ğ• Ì£Ì‚ğ•¥ ğ•”ğ•’Ìğ•”ğ•™ ğ•’ğ•Ÿ ğ•¥ğ• ğ•’Ì€ğ•Ÿ."
}

def handle_sms_command(message, message_object, thread_id, thread_type, author_id, client):
    parts = message.split()
    
    if len(parts) < 3:
        client.replyMessage(Message(text='ğŸš« **ğ•ğ®ğ¢ ğ¥ğ¨Ì€ğ§ğ  ğ§ğ¡ğšÌ£Ì‚ğ© ğ¬ğ¨Ì‚Ì Ä‘ğ¢ğÌ£Ì‚ğ§ ğ­ğ¡ğ¨ğšÌ£ğ¢ ğ¯ğšÌ€ ğ¬ğ¨Ì‚Ì ğ¥ğšÌ‚Ì€ğ§ ğ ğ®Ì›Ì‰ğ¢.*'), message_object, thread_id=thread_id, thread_type=thread_type, ttl=60000)
        return

    attack_phone_number, number_of_times = parts[1], int(parts[2])
    
    if not (attack_phone_number.isnumeric() and len(attack_phone_number) == 10 and attack_phone_number not in ['113', '911', '114', '115','0347460743']):
        client.replyMessage(Message(text='âŒ **ğ’ğ¨Ì‚Ì Ä‘ğ¢ğÌ£Ì‚ğ§ ğ­ğ¡ğ¨ğšÌ£ğ¢ ğ¤ğ¡ğ¨Ì‚ğ§ğ  ğ¡ğ¨Ì›Ì£ğ© ğ¥ğÌ£Ì‚ğŸ¤¬!.**'), message_object, thread_id=thread_id, thread_type=thread_type, ttl=60000)
        return

    current_time = datetime.datetime.now()
    is_admin = author_id in admin_ids

    # Háº¡n cháº¿ key FREE
    if not is_admin and (number_of_times < 1 or number_of_times > 5):
        client.replyMessage(Message(text='ğŸš« **Quang Huy chá»‰  cho phÃ©p spam tá»« 1 Ä‘áº¿n 5  vá»›i key FREE!**'), message_object, thread_id=thread_id, thread_type=thread_type, ttl=60000)
        return

    if not is_admin and author_id in last_sms_times and (current_time - last_sms_times[author_id]).total_seconds() < 120:
        client.replyMessage(Message(text="â³ **Vui lÃ²ng chá» 120 giÃ¢y vÃ  thá»­ láº¡i!**"), message_object, thread_id=thread_id, thread_type=thread_type, ttl=60000)
        return

    last_sms_times[author_id] = current_time
    process = subprocess.Popen(["python", os.path.join(os.getcwd(), "smsv2.py"), attack_phone_number, str(number_of_times)])

    for i in range(1, number_of_times + 1):
        time_str = current_time.strftime("%d/%m/%Y %H:%M:%S")
        masked_number = f"{attack_phone_number[:3]}***{attack_phone_number[-3:]}"
        
        msg_content = f"""
bot spam sms vÃ  call
ğŸ“ á´˜Êœá´É´á´‡: {masked_phone_number} 
â° á´›Éªá´á´‡: {time_str} 
ğŸ” ÊŸÉªÉ´á´‡: {i}/{number_of_times}
ğŸ‘¾ á´„á´á´ÊŸá´…á´á´¡É´: 120
ğŸ‘¤ ğ€ğğ¦ğ¢ğ§: TDungDzai
"""
        mention = Mention(author_id, length=len("NgÆ°á»i quáº£n lÃ½"), offset=0)
        style = MultiMsgStyle([MessageStyle(style="color", color="#4caf50", length=len(msg_content), offset=0)])

        client.replyMessage(Message(text=msg_content.strip(), style=style, mention=mention), message_object, thread_id=thread_id, thread_type=thread_type, ttl=60000)
        process.wait()

def get_mitaizl():
    return {'spamsms': handle_sms_command}